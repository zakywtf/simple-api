extends ../layouts/base

block content
	-function prettyDate(dateString){
		//if it's already a date object and not a string you don't need this line:
		-var date = new Date(dateString);
		-var d = date.getDate();
		-var monthNames = [ "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember" ];
		-var m = monthNames[date.getMonth()];
		-var dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
		-var currentDay = dayNames[date.getDay()];
		-var y = date.getFullYear();
		-return currentDay+', '+d+' '+m+' '+y;
	-}
	.container
		br
		//- br
		.card
			.card-body
				.row 
					.col-lg-10 
						h5.card-title.fw-semibold.mb-4 List Instansi
						p.mb-0 Berikut list instansi yang terdaftar
					.col-lg-2
						a.button.btn.btn-primary.btn-round.ml-auto(title='', data-original-title="Tambah Sekolah", data-toggle='modal', href='', data-target='#create')
							i.fa.fa-plus
							| 
							| Tambah Instansi
				br
				//- input#search.search-input(type="text", placeholder="Search...", oninput="filterTable()")
				.table-responsive
					table#dataTable.table.table-bordered
						thead.thead-light
							tr
								th No
								th Kode Instansi
								th Nama Instansi
								th Status
								th Bentuk Instansi
								th Alamat
								//- th Latitude
								//- th Longitude
								th Status
								th Masa Aktif
								th Aksi

						tbody
							-var no = 1;
							each data in datas
								tr
									td #{no++}
									td 
										b #{data.npsn}
									td 
										b #{data.name}
									//- td #{data.status}
									td.border-bottom-0
										.d-flex.align-items-center.gap-2
										if (data.school_status == 'negeri')
											span.badge.bg-primary.rounded-3.fw-semibold Negeri
										else 
											span.badge.bg-secondary.rounded-3.fw-semibold Swasta
												
									td #{data.category}
									td #{data.address}
									//- td #{data.latitude}
									//- td #{data.longitude}
									td.border-bottom-0
										.d-flex.align-items-center.gap-2
										if (data.status == 'active')
											span.badge.bg-success.rounded-3.fw-semibold Active
										else if (data.status == 'suspend')
											span.badge.bg-danger.rounded-3.fw-semibold Suspend
										else if (data.status == 'unpaid')
											span.badge.bg-warning.rounded-3.fw-semibold Unpaid
										else
											span.badge.bg-danger.rounded-3.fw-semibold Inactive
									td #{prettyDate(data.expired_date)}
									

									td
										button.btn.btn-outline-primary.dropdown-toggle(data-toggle="dropdown", href="#", aria-expanded="false")
											| Aksi
										ul.dropdown-menu
											//- if (data.status == 'active' || data.status == 'unpaid')
											//- 	li
											//- 		a.dropdown-item(href='/web/v1/projects/detail?_id=87654321') Suspend
											//- else if (data.status == 'suspend')
											//- 	li
											//- 		a.dropdown-item(href='/web/v1/projects/detail?_id=87654321') Active
											//- else if (data.status == 'unpaid')
											//- 	li
											//- 		a.dropdown-item(href='/web/v1/projects/detail?_id=87654321') Active
											//- 	li
											//- 		a.dropdown-item(href='/web/v1/projects/detail?_id=87654321') Suspend
											li
												a.dropdown-item(href=`https://maps.google.com/?q=${data.latitude},${data.longitude}`, target='_blank') Open Maps
											.dropdown-divider
											li
												a.dropdown-item(title='', data-original-title="Edit Sekolah", data-toggle='modal', href='', data-target='#edit'+data._id) Edit
											li 
												a.dropdown-item(title='', data-original-title="Delete Mesin", data-toggle='modal', href='', data-target='#delete'+data._id) Delete
							
							
					nav
						ul(style="justify-content: center;")#pagination.pagination

	.modal.fade(id='create',tabindex='-1', role='dialog', aria-labelledby='myModalLabel', aria-hidden='true')
		.modal-dialog(style="width: 800px;")
			.modal-content
				.modal-header
					h2
						b Tambah Instansi
					//- button.close(type="button", data-dismiss="modal")
					//- 	span(aria-hidden="true")
					//- 		i.ti.ti-square-x
					//- 	span.sr-only close
				.modal-body
					form#data-form.form-validation
						.form-group.row
							label.col-sm-4.form-control-label(for="npsn") Kode Instansi
								span.text-danger *
							.col-sm-8
								input#npsn.form-control(type="text", required, placeholder="Kode Instansi", name="npsn")
						br
						.form-group.row
							label.col-sm-4.form-control-label(for="name") Nama Instansi
								span.text-danger *
							.col-sm-8
								input#name.form-control(type="text", placeholder="Nama Instansi", required, name="name")
						br
						.form-group.row
							label.col-sm-4.form-control-label(for="school_status") Status
								span.text-danger *
							.col-sm-8
								select#school_status.form-control(name="school_status", required="required")
									option(value='') -- Pilih Status --
									option(value="negeri") Negeri
									option(value="swasta") Swasta
						br
						.form-group.row
							label.col-sm-4.form-control-label(for="category") Bentuk Instansi
								span.text-danger *
							.col-sm-8
								select#category.form-control(name="category", required="required")
									option(value='') -- Pilih Bentuk Instansi --
									//- option(value="MI") MI
									//- option(value="SD") SD
									option(value="SMP") SMP
									option(value="MTS") MTS 
									option(value="SMA") SMA
									option(value="SMK") SMK
									option(value="MA") MA
									option(value="PERSEROAN") PERSEROAN
						br
						.form-group.row
							label.col-sm-4.form-control-label(for="address") Alamat
								span.text-danger *
							.col-sm-8
								input#address.form-control(type="text", placeholder="Alamat", required, name="address")
						br
						.form-group.row
							label.col-sm-4.form-control-label(for="latitude") Latitude
								//- span.text-danger *
							.col-sm-8
								input#latitude.form-control(type="text", placeholder="Latitude", name="latitude")
						br
						.form-group.row
							label.col-sm-4.form-control-label(for="longitude") Longitude
								//- span.text-danger *
							.col-sm-8
								input#longitude.form-control(type="text", placeholder="Longitude", name="longitude")
						br
						.form-group.row
							label.col-sm-4.form-control-label(for="expired_date") Masa Aktif
								//- span.text-danger *
							.col-sm-8
								input#expired_date.form-control(type="date", name="expired_date")
						br
						.form-group.row
							.col-sm-12.col-sm-offset-4
								button.btn.btn-primary.waves-effect.waves-light(type="submit", style="float: right;")
									| Submit

	each data in datas 
		.modal.fade(id='edit'+data._id, tabindex='-1', role='dialog', aria-labelledby='myModalLabel', aria-hidden='true')
			.modal-dialog(style="width: 800px;")
				.modal-content
					.modal-header
						h2
							b Edit Instansi
						//- button.close(type="button", data-dismiss="modal")
						//- 	span(aria-hidden="true")
						//- 		i.ti.ti-square-x
						//- 	span.sr-only close
					.modal-body
						form#edit-form.form-validation(action='/schools/update/'+data._id, method='post')
							.form-group.row
								label.col-sm-4.form-control-label(for="npsn") Kode Instansi
									span.text-danger *
								.col-sm-8
									input#_id.form-control(type="hidden", placeholder="ID", name="_id", value=data._id)
									input#npsn.form-control(type="text", required, placeholder="Kode Instansi", name="npsn", value=data.npsn)
							br
							.form-group.row
								label.col-sm-4.form-control-label(for="name") Nama Instansi
									span.text-danger *
								.col-sm-8
									input#name.form-control(type="text", placeholder="Nama Instansi", required, name="name", value=data.name)
							br
							.form-group.row
								label.col-sm-4.form-control-label(for="school_status") Status
									span.text-danger *
								.col-sm-8
									select#school_status.form-control(name="school_status", required="required")
										option(value='') -- Pilih Status --
										option(value="negeri", selected=(data.school_status=='negeri')?'yes':undefined) Negeri
										option(value="swasta", selected=(data.school_status=='swasta')?'yes':undefined ) Swasta
							br
							.form-group.row
								label.col-sm-4.form-control-label(for="category") Bentuk Instansi
									span.text-danger *
								.col-sm-8
									select#category.form-control(name="category", required="required")
										option(value='') -- Pilih Bentuk Instansi --
										//- option(value="MI") MI
										//- option(value="SD") SD
										option(value="SMP", selected=(data.category=="SMP")?"yes":undefined) SMP
										option(value="MTS", selected=(data.category=="MTS")?"yes":undefined) MTS 
										option(value="SMA", selected=(data.category=="SMA")?"yes":undefined) SMA
										option(value="SMK", selected=(data.category=="SMK")?"yes":undefined) SMK
										option(value="MA", selected=(data.category=="MA")?"yes":undefined) MA
										option(value="PERSEROAN", selected=(data.category=="PERSEROAN")?"yes":undefined) PERSEROAN
							br
							.form-group.row
								label.col-sm-4.form-control-label(for="address") Alamat
									span.text-danger *
								.col-sm-8
									input#address.form-control(type="text", placeholder="Alamat", required, name="address", value=data.address)
							br
							.form-group.row
								label.col-sm-4.form-control-label(for="latitude") Latitude
									//- span.text-danger *
								.col-sm-8
									input#latitude.form-control(type="text", placeholder="Latitude", name="latitude", value=data.latitude)
							br
							.form-group.row
								label.col-sm-4.form-control-label(for="longitude") Longitude
									//- span.text-danger *
								.col-sm-8
									input#longitude.form-control(type="text", placeholder="Longitude", name="longitude", value=data.longitude)
							br
							.form-group.row
								label.col-sm-4.form-control-label(for="expired_date") Masa Aktif
									//- span.text-danger *
								.col-sm-8
									input#expired_date.form-control(type="date", name="expired_date", value=data.expired_date.toISOString().split('T')[0])
							br
							.form-group.row
								.col-sm-12.col-sm-offset-4
									button.btn.btn-primary.waves-effect.waves-light(type="submit", style="float: right;")
										| Submit

	// pop up delete data
	each data in datas
		.modal.fade(id='delete'+data._id ,tabindex='-1', role='dialog', aria-labelledby='myModalLabel', aria-hidden='true')
			.modal-dialog
				.modal-content
					.modal-header
						h4#myModalLabel.modal-title Peringatan!
					.modal-body
						h5 Apakah anda yakin untuk menghapus data #{data.name} ?
					.modal-footer
						a.btn.btn-danger#tambah(type='button', href='schools/delete/'+data._id) Ya
						button.btn.btn-primary(type='button', data-dismiss='modal') Tidak
				// /.modal-content
			// /.modal-dialog
		// /.modal

	script(src="https://code.jquery.com/jquery-3.5.1.min.js")
	script(src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js")
	script.
		var pOptions = document.getElementById('school_status').options;
		for (i=0; i < pOptions.length; i++) {
			if (pOptions[i].value == '') pOptions[i].selected = true;
		}

	script.
		let currentPage = 1;
		const rowsPerPage = 10;

		function displayTable(page) {
			const rows = $('#dataTable tbody tr');
			const totalRows = rows.length;
			const totalPages = Math.ceil(totalRows / rowsPerPage);
			const start = (page - 1) * rowsPerPage;
			const end = start + rowsPerPage;

			rows.hide().slice(start, end).show();
			updatePagination(totalPages);
		}

		function updatePagination(totalPages) {
			const pagination = $('#pagination');
			pagination.empty();

			const prevButton = $('<li class="page-item"><a class="page-link" href="#">Previous</a></li>');
			if (currentPage === 1) prevButton.addClass('disabled');
			prevButton.click(function () {
				if (currentPage > 1) {
					currentPage--;
					displayTable(currentPage);
				}
			});
			pagination.append(prevButton);

			for (let i = 1; i <= totalPages; i++) {
				const pageButton = $('<li class="page-item"><a class="page-link" href="#">' + i + '</a></li>');
				if (currentPage === i) pageButton.addClass('active');
				pageButton.click(function () {
					currentPage = i;
					displayTable(currentPage);
				});
				pagination.append(pageButton);
			}

			const nextButton = $('<li class="page-item"><a class="page-link" href="#">Next</a></li>');
			if (currentPage === totalPages) nextButton.addClass('disabled');
			nextButton.click(function () {
				if (currentPage < totalPages) {
					currentPage++;
					displayTable(currentPage);
				}
			});
			pagination.append(nextButton);
		}

		function filterTable() {
			const filter = $('#search').val().toLowerCase();
			const filteredRows = $('#dataTable tbody tr').filter(function () {
				return $(this).text().toLowerCase().includes(filter);
			});

			$('#dataTable tbody').empty().append(filteredRows);

			currentPage = 1; // Reset to first page
			displayTable(currentPage);
		}

		$(document).ready(function () {
			displayTable(currentPage);
		});

	script.
		document.getElementById('data-form').addEventListener('submit', function(event) {
			event.preventDefault();
			var host = window.location.origin;
			const token = localStorage.getItem('token');
			const formData = new FormData(this);
			const data = Object.fromEntries(formData);

			// Option 1: Using fetch API
			fetch(host + '/api/v1/schools', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${token}`
				},
				body: JSON.stringify(data)
			})
			.then(response => {
				console.log({response})
				if (!response.ok) {
					throw new Error('Network response was not ok');
				}
				//- return response.json(); 
				window.location.href = host+'/schools'

			})
			.then(data => {
				console.log('Success:', data);
			})
			.catch(error => {
				console.error('Error:', error);
			});
		});

	//- script.
	//- 	document.getElementById('edit-form').addEventListener('submit', function(event) {
	//- 		event.preventDefault();
	//- 		var host = window.location.origin;
	//- 		const token = localStorage.getItem('token');
	//- 		const formData = new FormData(this);
	//- 		const data = Object.fromEntries(formData);
	//- 		const _id = document.getElementById("_id").value;

	//- 		// Option 1: Using fetch API
	//- 		fetch(host + '/api/v1/schools/update/'+_id, {
	//- 			method: 'PUT',
	//- 			headers: {
	//- 				'Content-Type': 'application/json',
	//- 				'Authorization': `Bearer ${token}`
	//- 			},
	//- 			body: JSON.stringify(data)
	//- 		})
	//- 		.then(response => {
	//- 			console.log({response})
	//- 			if (!response.ok) {
	//- 				throw new Error('Network response was not ok');
	//- 			}
	//- 			//- return response.json(); 
	//- 			window.location.href = host+'/schools'

	//- 		})
	//- 		.then(data => {
	//- 			console.log('Success:', data);
	//- 		})
	//- 		.catch(error => {
	//- 			console.error('Error:', error);
	//- 		});
	//- 	});
		